// Prisma Schema — Painel SaaS IARA
// Conecta ao mesmo PostgreSQL do N8N (iara-system)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Auth — Clínicas (Doutoras)
// ============================================

model Clinica {
  id              String    @id @default(cuid())
  nome            String
  email           String    @unique
  senha           String
  role            String    @default("cliente")
  
  nomeDoutora     String?
  
  whatsappClinica  String?
  whatsappPessoal  String?
  
  nomeIA          String    @default("IARA")
  diferenciais    String?   @db.Text
  
  plano           Int       @default(1)
  creditosTotal   Int       @default(100)
  creditosUsados  Int       @default(0)
  dataRenovacao   DateTime?
  
  // Hotmart
  hotmartOrderId  String?
  status          String    @default("ativo") // ativo | cancelado | suspenso
  
  whatsappStatus  String    @default("desconectado")
  instanceName    String?
  
  procedimentos   Procedimento[]
  horarios        HorarioFuncionamento?
  conversas       Conversa[]
  agendamentos    Agendamento[]
  creditoHistorico CreditoHistorico[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("clinicas")
}

model Procedimento {
  id          String  @id @default(cuid())
  clinicaId   String
  nome        String
  valor       Float
  desconto    Int     @default(0)
  parcelas    String?
  duracao     String?
  ativo       Boolean @default(true)
  
  clinica     Clinica @relation(fields: [clinicaId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([clinicaId])
  @@map("procedimentos")
}

model HorarioFuncionamento {
  id              String  @id @default(cuid())
  clinicaId       String  @unique
  
  semanaInicio    String  @default("09:00")
  semanaFim       String  @default("18:00")
  almocoSemana    Boolean @default(false)
  almocoInicio    String?
  almocoFim       String?
  
  sabado          Boolean @default(false)
  sabadoInicio    String?
  sabadoFim       String?
  almocoSabado    Boolean @default(false)
  almocoSabInicio String?
  almocoSabFim    String?
  
  domingo         Boolean @default(false)
  domingoInicio   String?
  domingoFim      String?
  
  feriado         Boolean @default(false)
  feriadoInicio   String?
  feriadoFim      String?
  
  intervalo       Int     @default(15)
  antecedenciaMin Int     @default(2)
  antecedenciaMax Int     @default(30)
  
  clinica         Clinica @relation(fields: [clinicaId], references: [id], onDelete: Cascade)
  
  @@map("horarios_funcionamento")
}

model Conversa {
  id            String    @id @default(cuid())
  clinicaId     String
  telefone      String
  nome          String?
  ultimaMensagem String?  @db.Text
  ultimaData    DateTime?
  status        String    @default("ativo")
  lida          Boolean   @default(false)
  
  clinica       Clinica   @relation(fields: [clinicaId], references: [id], onDelete: Cascade)
  mensagens     Mensagem[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([clinicaId])
  @@index([telefone])
  @@map("conversas")
}

model Mensagem {
  id          String   @id @default(cuid())
  conversaId  String
  remetente   String
  conteudo    String   @db.Text
  tipo        String   @default("texto")
  
  conversa    Conversa @relation(fields: [conversaId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@index([conversaId])
  @@map("mensagens")
}

model Agendamento {
  id            String    @id @default(cuid())
  clinicaId     String
  nomePaciente  String
  telefone      String?
  procedimento  String
  data          DateTime
  horario       String
  duracao       String?
  status        String    @default("pendente")
  
  clinica       Clinica   @relation(fields: [clinicaId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([clinicaId])
  @@index([data])
  @@map("agendamentos")
}

model CreditoHistorico {
  id          String   @id @default(cuid())
  clinicaId   String
  acao        String
  creditos    Int
  tipo        String
  
  clinica     Clinica  @relation(fields: [clinicaId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@index([clinicaId])
  @@map("credito_historico")
}

model ConfigAtendimento {
  id          String  @id @default(cuid())
  clinicaId   String  @unique
  
  saudacao       Boolean @default(true)
  perguntarNome  Boolean @default(true)
  oferecerDesc   Boolean @default(true)
  enviarAudio    Boolean @default(false)
  enviarPreco    Boolean @default(true)
  enviarFotos    Boolean @default(true)
  reagendarAuto  Boolean @default(true)
  listaEspera    Boolean @default(false)
  avaliacaoPos   Boolean @default(true)
  lembrete24h    Boolean @default(true)
  lembrete1h     Boolean @default(true)
  confirmacao    Boolean @default(true)
  bloqueioSpam   Boolean @default(true)
  
  feedbacks      Json?
  
  @@map("config_atendimento")
}
